<!DOCTYPE html>
<html>
  <head>
    <title>Test</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
	<script src="http://code.highcharts.com/highcharts.js"></script>
	<script src="http://code.highcharts.com/highcharts-more.js"></script>
	<script src="http://code.highcharts.com/modules/exporting.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	
    <script>

    	var clapping;
    	var participants;
    	var uids = Object();
    	$(function () {
		    clapping = new Highcharts.Chart({
		    
		        chart: {
		            renderTo: 'container_1',
		            type: 'gauge',
		        },
		    
		        title: {
		            text: 'Clapometer'
		        },
		        
		        pane: {
		            startAngle: -150,
		            endAngle: 150
		        },            
		    
		        yAxis: [{
		            min: 0,
		            max: 200,
		        }],
		    
		        series: [{
		            name: 'Enthusiasm',
		            data: [0],
		        }]
		    
		    },
		     function(clapping) {
		        setInterval(function() {
		            var point = clapping.series[0].points[0];
		            var newVal;
		    
		            if (point.y > 0) {
		                newVal = point.y - 2;
		            }
		    
		            point.update(newVal);
		    
		        }, 100);
		    
		    });
		    
		    participants = new Highcharts.Chart({
		    
		        chart: {
		            renderTo: 'container_2',
		            type: 'bar',
		        },
		    
		        title: {
		            text: 'Participants'
		        },
		                 		    
		        yAxis: [{
		            min: 0,
		            max: 20,
		        }],
		    
		        series: [
		        {
		            name: 'Current',
		            data: [0],
		        }
		        ]
		    
		    },
		     function(participants) {
		        setInterval(function() {
		        	
		            var point = participants.series[0].points[0];
		            var newVal;
		    
		            if (point.y > 0) {
		                newVal = point.y - 0.01;
		            }
		            
		            var now = new Date().getTime();
		            
		            for (var key in uids) {
		            	if (uids[key] < now - 1000){
		            		delete uids[key];
		            	}
		            }

		            point.update(Object.keys(uids).length);
		    
		        }, 100);
		    
		    });
		});
    	
    	var socket = io.connect('http://localhost:3000');
		socket.emit('event', '<%= event %>');
		socket.on('message', function (data) {
			uids[data.user] = new Date().getTime();
			
			var point = clapping.series[0].points[0];
			var newVal;
     
	        if (point.y < 200) {
	            newVal = point.y + parseInt(data.power);
	        }
	
	        point.update(newVal);
		});
    	
	</script>
  </head>
  <body>
    <div id="container_1" style="min-width: 400px; height: 500px; margin: 0 auto"></div>
    <div id="container_2" style="min-width: 400px; height: 500px; margin: 0 auto"></div>
  </body>
</html>