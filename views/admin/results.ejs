<!DOCTYPE html>
<html>
  <head>
    <title>Viewing Results</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
	<script src="http://code.highcharts.com/highcharts.js"></script>
	<script src="http://code.highcharts.com/highcharts-more.js"></script>
	<script src="http://code.highcharts.com/modules/exporting.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	
    <script>

    	var clapping_chart;
    	var participant_chart;
    	var current_participants = Object();
    	var total_participants = Object();
    	$(function () {
		    clapping_chart = new Highcharts.Chart({
		    
		        chart: {
		            renderTo: 'container_1',
		            type: 'gauge',
		        },
		    
		        title: {
		            text: 'Clapometer'
		        },
		        
		        pane: {
		            startAngle: -150,
		            endAngle: 150
		        },            
		    
		        yAxis: [{
		            min: 0,
		            max: 200,
		        }],
		    
		        series: [{
		            name: 'Enthusiasm',
		            data: [0],
		        }]
		    
		    },
		     function(clapping_chart) {
		        setInterval(function() {
		            var point = clapping_chart.series[0].points[0];
		            var newVal;
		    
		            if (point.y > 0) {
		                newVal = point.y - 2;
		            }
		    
		            point.update(newVal);
		    
		        }, 100);
		    
		    });
		    
		    participant_chart = new Highcharts.Chart({
		    
		        chart: {
		            renderTo: 'container_2',
		            type: 'bar',
		        },
		    
		        title: {
		            text: 'Participants'
		        },
		                 		    
		        yAxis: [{
		            min: 0,
		            max: 20,
		        }],
		    
		        series: [
		        {
		            name: 'Current',
		            data: [0],
		        },
		        {
		            name: 'Total',
		            data: [0],
		        }
		        ]
		    
		    },
		     function(participant_chart) {
		        setInterval(function() {
		        	
		            var point = participant_chart.series[0].points[0];
		            var newVal;
		    
		            if (point.y > 0) {
		                newVal = point.y - 0.01;
		            }
		            
		            var now = new Date().getTime();
		            
		            for (var key in current_participants) {
		            	if (current_participants[key] < now - 1000){
		            		delete current_participants[key];
		            	}
		            }

		            point.update(Object.keys(current_participants).length);
		    
		        }, 100);
		    
		    });
		});
    	
    	var socket = io.connect('http://localhost:3000');
		socket.emit('event', '<%= event %>');
		
		socket.on('exit', function (data) {
			delete total_participants[data.user];
			var point = participant_chart.series[1].points[0];
     		point.update(Object.keys(total_participants).length);
		});
		
		socket.on('join', function (data) {
			total_participants[data.user] = new Date().getTime();
			var point = participant_chart.series[1].points[0];
     		point.update(Object.keys(total_participants).length);
		});

		
		socket.on('message', function (data) {
			current_participants[data.user] = new Date().getTime();
			
			var point = clapping_chart.series[0].points[0];
			var newVal;
     
	        if (point.y < 200) {
	            newVal = point.y + parseInt(data.power);
	        }
	
	        point.update(newVal);
		});
    	
	</script>
  </head>
  <body>
  	<b>Managing Event: <%= event%>
    <div id="container_1" style="min-width: 400px; height: 500px; margin: 0 auto"></div>
    <div id="container_2" style="min-width: 400px; height: 500px; margin: 0 auto"></div>
  </body>
</html>